---
title: MySQL
tags:
  - sql
categories:
  - 数据库
date: 2017-08-14 18:06:41
---



## 服务器元数据

命令|描述
--|--
`SELECT VERSION()`|版本信息
`SELECT DATABASE()`|当前数据库名
`SELECT USER()`|当前用户名
`SHOW STATUS`|服务器状态
`SHOW VARIABLES`|配置变量

## 描述表结构

```mysql
DESCRIBE table_name;
SHOW CREATE TABLE table_name;
SHOW COLUMNS FROM table_name;
SHOW INDEX FROM table_name;
SHOW TABLE STATUS LIKE 'table_name'\G
```

## ALTER TABLE

```mysql
# 添加列
ALTER TABLE table_name
ADD column_name datatype;

# 删除列
ALTER TABLE table_name
DROP COLUMN column_name;

# 修改列的数据类型
ALTER TABLE table_name
CHANGE COLUMN old_col new_col datatype;

# 改变 AUTO_INCREMENT 的起始值
ALTER TABLE table_name AUTO_INCREMENT=100;
```

## CONSTRAINT

### PRIMARY KEY

```mysql
ALTER TABLE table_name
ADD PRIMARY KEY (col);
# 或多个列定义
ADD CONSTRAINT pk_name PRIMARY KEY (col1,col2);
```

撤销 PRIMARY KEY 约束

```mysql
ALTER TABLE table_name
DROP PRIMARY KEY;
```

### UNIQUE

a unique constrait is also an **index**

```mysql
ALTER TABLE table_name
ADD UNIQUE (col);
# 或命名 UNIQUE 约束，并定义多个列的 UNIQUE 约束
ADD CONSTRAINT constraint_name UNIQUE (col1,col2);
```

要 drop 掉表中的唯一约束先要找出索引的名字，`Key_name` 便是索引的名字

```mysql
SHOW INDEX FROM table_name;
```

```mysql
DROP INDEX index_name ON table_name;
# 或者使用 alter 语法
ALTER TABLE table_name
DROP INDEX index_name;
```

### INDEX

```mysql
CREATE INDEX index_name
ON table_name(col1,col2);

# 创建唯一索引
CREATE UNIQUE INDEX index_name
ON table_name(column_name);
```

使用 `ALTER` 命令添加索引

```mysql
ALTER TABLE table_name ADD PRIMARY KEY (col...);

# 唯一索引，指定索引长度
ALTER TABLE table_name ADD UNIQUE index_name (col(20));

ALTER TABLE table_name ADD INDEX index_name (col...);

# 全文索引
ALTER TABLE table_name ADD FULLTEXT index_name (col...);
```

#### 使用全文索引语法

```mysql
SELECT * FROM table_name
WHERE MATCH(`col1`, `col2`) AGAINST('foo bar');
```

### FOREIGN KEY

外键约束能防止非法数据插入外键列，它必须是它指向的那个表中的值之一

```mysql
CREATE TABLE orders
(
o_id int NOT NULL,
order_no int NOT NULL,
u_id int,
PRIMARY KEY (o_id),
FOREIGN KEY (u_id) REFERENCES users(u_id)
# 或命名外键
CONSTRAINT fk_name FOREIGN KEY (u_id) REFERENCES users(u_id) ON DELETE CASCADE
)
```

已经存在表后添加外键约束

```mysql
ALTER TABLE table_name
ADD CONSTRAINT fk_name
FOREIGN KEY (u_id)
REFERENCES users(u_id);
```

drop 掉外键约束

```mysql
ALTER TABLE table_name
DROP FOREIGN KEY fk_name;
```

### CHECK

限制列中的值的范围

> MySQL 不支持 check 约束，可以定义约束，但不会起作用
> PostgreSQL 支持

```mysql
CREATE TABLE table_name
(
...
CHECK (col1 > 0)
CONSTRAINT check_name CHECK (col2 > 0 AND col3 = 'foo')
)
```

已存在的表添加 CHECK 约束

```mysql
ALTER TABLE table_name
ADD CHECK (col1 > 0);
# 或命名 check
CONSTRAINT check_name CHECK (col2 > 0 AND col3 = 'foo')
)
```

drop 掉 check 约束

```mysql
ALTER TABLE table_name
DROP CHECK check_name;
# 或
DROP CONSTRAINT check_name;
```

### DEFAULT

```mysql
ALTER TABLE table_name
ALTER col SET DEFAULT 'value';
# 或
ALTER COLUMN col SET DEFAULT 'value';
```

drop DEFAULT

```mysql
alter table table_name
alter col DROP DEFAULT;
# 或
alter column col DROP DEFAULT;
```

## 视图

```mysql
CREATE VIEW view_name AS
SELECT col1,col2 FROM table_name;

SHOW CREATE TABLE view_name;
SHOW CREATE VIEW view_name;

ALTER VIEW view_name AS new_defination...;

DROP VIEW view_name;
```

## 管理用户

```mysql
# 添加用户
INSERT INTO user
(host, user, password, select_priv)
VALUES
('localhost', 'foo', PASSWORD('password'), 'Y');

# 添加用户
CREATE USER 'foo'@'localhost' IDENTIFIED BY 'password';

# 添加用户并指定权限
GRANT ALL PRIVILEGES
ON some_db.*
To 'user'@'localhost'
IDENTIFIED BY 'password';

GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP
ON some_db.*
TO 'foo'@'localhost'
IDENTIFIED BY 'password';

# 显示用户权限
SHOW GRANTS FOR 'root'@'localhost';

# 删除用户
DROP USER 'foo'@'localhost';
```

### 重新载入授权表

```mysql
FLUSH PRIVILEGES;
```

### 查看安全策略

```mysql
SHOW VARIABLES LIKE 'validate_password%' ;

# 改变变量值
SET GLOBAL variable=value;
```

## 正则匹配

不同于 `LIKE` 使用 `REGEXP`

```mysql
SELECT col FROM table_name
WHERE col REGEXP '^foo.{3}$';
```

## 事务

> 只有使用了 `Innodb` 数据库引擎的数据库或表才支持事务。

## 创建临时表


```mysql
CREATE TEMPORARY TABLE table_name
(
...
)
```

## 复制表的思路

1. 使用 `SHOW CREATE TABLE table_name \G` 获取表完整结构；
2. 修改SQL 语句的表名，并执行创建新表；
3. 执行 `INSERT INTO ... SELECT` 复制完整数据

### 通过复制表删除重复数据

```mysql
CREATE TABLE tmp
SELECT col1, col2, ...
FROM table_name
GROUP BY (col1, col2, ...);

DROP TABLE table_name;

ALTER TABLE tmp RENAME TO table_name;
```

## 导出导入数据

### SELECT INTO OUTFILE

指定分隔符，导出成 CSV 格式

```mysql
SELECT * FROM table_name
INTO OUTFILE '/path/to/file.txt'
FIELDS TERMINATED BY ','
OPTIONALLY ENCLOSED BY '"'
LINES TERMINATED BY '\r\n';
```

```mysql
LOAD DATA LOCAL INFILE 'dump.txt' INTO TABLE table_name;
```

### mysqldump

```bash
$ mysqldump -u user -p database [table_name] > dump.sql
$ mysqldump -u user -p --no-create-info database [table_name] > dump.sql
$ mysqldump -u user -p --all-databases > dump.sql
```

