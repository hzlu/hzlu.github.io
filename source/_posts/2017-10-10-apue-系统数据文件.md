---
title: APUE 系统数据文件
tags:
  - unix
categories:
  - unix
date: 2017-10-10 18:23:22
---


- 使用nobody用户名的目的是，使任何人都可以登录到系统，但不提供任何特权。
- `finger -p $(whoami)` finger 命令打印用户有关信息

## 获取口令文件项的函数

```c
#include <pwd.h>

struct passwd *getpwuid(uid_t uid);
struct passwd *getpwnam(const char *name);
```

## 查看整个口令文件函数

```c
struct passwd *getpwent(void);
/* 返回口令文件中的下一个记录项 */

void setpwent(void);
/* 反绕它所打开的文件，使它们定位到文件开始处 */

void endpwent(void);
/* 一定要调用endpwent关闭这些文件 */
```

## 阴影文件

访问阴影口令文件 `/etc/passwd` 的函数

```c
#include <shadow.h>

struct spwd *getspnam(const char *name);
struct spwd *getspent(void);

void setspent(void);
void endspent(void);
```

## 组文件

```c
#include <grp.h>

struct group *getgrgid(gid_t gid);
struct group *getgrnam(const char *name);
```

返回指向一个静态变量的指针，在每次调用时都会重写该静态变量。

搜索整个组文件 `/etc/group` 的函数

```c
#include <grp.h>

struct group *getgrent(void);

void setgrent(void);
void endgrent(void);
```

## 附加组ID

- 以前，每个用户任何时候都只属于一个实际组
- `newgrp` 命令更改组ID
- 后来引入附加组ID的概念
- 可以属于多达16（常量 `NGROUPS_MAX` 规定）个另外的组
- 文件访问权限检查改为：
  + 将进程有效组ID与文件组ID相比较
  + 将所有附加组ID与文件的组ID进行比较
- 使用附加组ID的优点是不必显式更改组

获取和设置附加组ID的函数

```c
#include <unistd.h>
int getgroups(int gidsetsize, gid_t grouplist[]);
/* 成功返回附加组ID数，出错返回 -1 */
/* 将附加组ID填写到数组grouplist中，该数组存放元素最多为 gidsetsize 个 */

#include <grp.h>
int setgroups(int ngroups, const gid_t grouplist[]);
int initgroups(const char *username, gid_t basegid);
/* 超级用户调用 */
```

## 其他数据文件

- 主机 /etc/hosts
- 网络 /etc/networks
- 协议 /etc/protocols
- 服务 /etc/services

## utmp 和 wtmp 文件

- `/var/run/utmp` 文件 记录当前登录进系统的各个用户
- `/var/log/wtmp` 文件 跟踪各个登录和注销事件

写入这两个文件中的是下列结构的一条二进制记录

```c
struct utmp {
  char ut_line[8];
  char ut_name[8];
  long ut_time;
};
```

- 登录时，login程序填写此类型结构，然后将其写入utmp文件中，同时添写到wtmp文件中
- 注销时，init进程将utmp文件中相应的记录擦除，并将一个新记录添写到wtmp文件中

## 系统标识

```c
#include <sys/utsname.h>

int uname(struct utsname *name);
```

```c
struct utsname {
  char sysname[];
  char nodename[];
  char release[];
  char version[];
  char machine[];
};
```

每个数组的长度由实现确定，以上是该结构至少需要提供的字段

- hostname 命令可用来获取和 *设置* 主机名

## 时间和日期例程

- 日历时间 `time_t`
- 以国际标准时间而非本地时间计时
- 可自动进行转换

```c
#include <time.h>

time_t time(time_t *calptr);
```

返回当前时间值，如果参数不为空，则时间值也会存放在 calptr 指向的单元里

```c
#include <sys/time.h>

int gettimeofday(struct timeval *restrict tp, void *restrict tzp);
```

- gettimeofday 提供更高的分辨率，最高为微秒级
- tzp 唯一合法值是NULL
- 其他tzp值产生不确定结果
- 某些平台支持用tzp说明时区
- 当前时间存放在tp指向的timeval结构中

```c
struct timeval {
  time_t tv_sec;
  long tv_usec;
};
/* 该结构存储秒和微妙 */
```

