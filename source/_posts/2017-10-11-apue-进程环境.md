---
title: APUE 进程环境
tags:
  - unix
categories:
  - unix
date: 2017-10-11 11:48:39
---


## main函数执行

```c
int main(int argc, char *argv[]);
```

- 内核在调用main前先调用一个特殊的 *启动例程*
- 启动例程从内核取得 *命令行参数* 和 *环境变量值*
- 启动例程被指定为程序的起始地址

## 进程终止 termination

- 正常终止
  + 从main返回
  + 调用exit
  + 调用 _exit 或 _Exit
  + 最后一个线程从其启动例程返回
  + 最后一个线程调用 pthread_exit
- 异常终止
  + 调用abort
  + 接到一个信号并终止
  + 最后一个线程对取消请求做出响应

启动例程常常用汇编编写，如果用C代码表示可能是：

  exit(main(argc, argv));

### exit 函数

```c
#include <stdlib.h>
void exit(int status);
void _Exit(int status);

#include <unistd.h>
void _exit(int status);
```

- _exit 和 _Exit 函数会立即进入内核
- exit则先执行一些清除处理（执行终止处理程序，关闭所有标准IO流）然后进入内核
- 三个函数都带有一个整型参数，终止状态，退出状态
- 终止状态未定义
  + 调用exit时不带终止状态
  + main执行一个不带返回值的return
  + main没有声明返回整型
- 终止状态为0
  + 返回类型声明为整型，main最后一条语句返回，或隐式返回

### atexit 函数

一个进程可以登记多达32个函数，这些函数由exit自动调用，这些函数称为 *终止处理程序* exit handler

```c
#include <stdlib.h>

int atexit(void (*func)(void));
```

- 参数是一个函数地址
- 无需传递任何参数
- 也不期望返回值
- 调用顺序与登记顺序 *相反*
- 多次登记多次调用

![](/images/C程序启动和终止.jpeg)


